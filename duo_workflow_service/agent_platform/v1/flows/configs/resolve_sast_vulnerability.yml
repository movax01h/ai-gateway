version: "v1"
environment: ambient

components:
  - name: "gather_context"
    type: DeterministicStepComponent
    tool_name: "get_vulnerability_details"
    inputs:
      - { from: "context:goal", as: "vulnerability_id" }
    ui_log_events:
      - "on_tool_execution_success"
      - "on_tool_execution_failed"

  - name: "execute_fix"
    type: AgentComponent
    prompt_id: "resolve_sast_vulnerability_execution"
    prompt_version: "^1.0.0"
    inputs:
      - from: "context:gather_context.tool_responses"
        as: "vulnerability_context"
    toolset: ["edit_file", "create_file_with_contents", "read_file", "read_files", "grep", "find_files", "list_dir", "run_command"]

  - name: "commit_changes"
    type: OneOffComponent
    prompt_id: "resolve_sast_vulnerability_commit"
    prompt_version: "^1.0.0"
    max_correction_attempts: 3
    inputs:
      - from: "context:gather_context.tool_responses"
        as: "vulnerability_context"
      - from: "context:project_http_url_to_repo"
        as: "repository_url"
      - from: "context:workflow_id"
        as: "workflow_id"
    toolset: ["run_git_command"]
    ui_log_events:
      - "on_tool_call_input"
      - "on_tool_execution_success"
      - "on_tool_execution_failed"

  - name: "push_and_create_mr"
    type: OneOffComponent
    prompt_id: "resolve_sast_vulnerability_push_and_create_mr"
    prompt_version: "^1.0.0"
    max_correction_attempts: 3
    inputs:
      - from: "context:gather_context.tool_responses"
        as: "vulnerability_details"
      - from: "context:execute_fix.final_answer"
        as: "fix_summary"
      - from: "context:project_http_url_to_repo"
        as: "repository_url"
      - from: "context:workflow_id"
        as: "workflow_id"
      - from: "context:project_id"
        as: "project_id"
      - from: "context:project_default_branch"
        as: "default_branch"
    toolset: ["run_git_command", "create_merge_request"]
    ui_log_events:
      - "on_tool_call_input"
      - "on_tool_execution_success"
      - "on_tool_execution_failed"

  - name: "check_false_positive"
    type: AgentComponent
    prompt_id: "resolve_sast_check_false_positive"
    prompt_version: "^1.0.0"
    inputs:
      - from: "context:push_and_create_mr.tool_responses"
        as: "git_operations_result"
      - from: "context:project_http_url_to_repo"
        as: "repository_url"
      - from: "context:workflow_id"
        as: "workflow_id"
      - from: "context:gather_context.tool_responses"
        as: "vulnerability_context"
    toolset:
      - "get_merge_request"
      - "list_merge_request_diffs"
      - "create_merge_request_note"
      - "update_merge_request"
    ui_log_events:
      - "on_agent_final_answer"
      - "on_tool_execution_success"

  - name: "link_vulnerability"
    type: DeterministicStepComponent
    tool_name: "link_vulnerability_to_merge_request"
    inputs:
      - from: "context:gather_context.tool_responses.vulnerability.id"
        as: "vulnerability_id"
      - from: "context:push_and_create_mr.tool_responses.merge_request.id"
        as: "merge_request_id"
    ui_log_events:
      - "on_tool_execution_success"
      - "on_tool_execution_failed"

  - name: "evaluate_merge_request"
    type: AgentComponent
    prompt_id: "resolve_sast_evaluate_mr_readiness"
    prompt_version: "^1.0.0"
    inputs:
      - from: "context:gather_context.tool_responses"
        as: "vulnerability_context"
      - from: "context:execute_fix.final_answer"
        as: "fix_execution_result"
      - from: "context:push_and_create_mr.tool_responses"
        as: "git_operations_result"
      - from: "context:project_http_url_to_repo"
        as: "repository_url"
      - from: "context:workflow_id"
        as: "workflow_id"
      - from: "context:check_false_positive.final_answer"
        as: "false_positive_check"
    toolset:
      - "get_merge_request"
      - "list_merge_request_diffs"
    ui_log_events:
      - "on_agent_final_answer"
      - "on_tool_execution_success"

routers:
  - from: "gather_context"
    to: "execute_fix"
  - from: "execute_fix"
    to: "commit_changes"
  - from: "commit_changes"
    to: "push_and_create_mr"
  - from: "push_and_create_mr"
    to: "check_false_positive"
  - from: "check_false_positive"
    to: "link_vulnerability"
  - from: "link_vulnerability"
    to: "evaluate_merge_request"
  - from: "evaluate_merge_request"
    to: "end"

flow:
  entry_point: "gather_context"
