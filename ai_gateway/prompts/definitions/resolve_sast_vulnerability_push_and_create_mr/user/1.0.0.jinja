<critical_execution_requirement>
YOU MUST MAKE EXACTLY TWO TOOL CALLS IN YOUR RESPONSE:
1. run_git_command (to push the branch)
2. create_merge_request (to create the MR)

DO NOT make only one tool call. DO NOT wait for the first to complete.
BOTH calls must be in the SAME response or the workflow will fail.
</critical_execution_requirement>

<instructions>
<step number="1" name="parse_vulnerability_data">
Parse vulnerability_details JSON to extract:
- vulnerability.id (required - may be in GID format like "gid://gitlab/Vulnerability/12345")
    If vulnerability.id is in GID format: Extract ONLY the numeric ID at the end
- vulnerability.reportType (required)
- vulnerability.title (optional)
- vulnerability.severity (optional)

Parse fix_summary JSON to extract the complete analysis and implementation details:
- vulnerability_analysis (source, sink, data flow, root cause)
- remediation_approach (strategy, security pattern, quantifiable improvement)
- implementation (primary_changes, supporting_changes with justifications)
- execution_result (status, verification, notes)
</step>

<step number="2" name="construct_branch_name">
Branch name: security/sast-fix-<vulnerability_id>-<workflow_id>
Example: "security/sast-fix-4313-360"
</step>

<step number="3" name="FIRST_TOOL_CALL_push_branch">
FIRST TOOL CALL - run_git_command:

run_git_command(
    repository_url="<repository_url>",
    command="push",
    args="-u origin HEAD:refs/heads/<branch_name>"
)
</step>

<step number="4" name="construct_mr_metadata">
MR Title: fix(security): Resolve <TYPE> vulnerability #<ID>

MR Description Template:

## Security Fix: <vulnerability type>

**Addresses:** Vulnerability #<vulnerability_id> detected by SAST

### Vulnerability Details

- **ID:** [vulnerability:<numeric_id_only>]
- **Type:** <vulnerability.reportType>
- **Severity:** <severity if available>
- **Location:** <file:line from vulnerability_analysis>

### Source/Sink Analysis

**Source (Data Origin):**
- **Location:** <source_location from fix_summary.vulnerability_analysis>
- **Description:** <explain where untrusted data enters>

**Data Flow:**
<data_flow from fix_summary.vulnerability_analysis - how data moves through functions>

**Sink (Dangerous Operation):**
- **Location:** <sink_location from fix_summary.vulnerability_analysis>
- **Description:** <explain where dangerous operation occurs>

**Root Cause:**
<root_cause from fix_summary.vulnerability_analysis - function-level explanation with evidence>

**Attack Vector:**
<attack_vector from fix_summary.vulnerability_analysis - how this could be exploited>

### Remediation Approach

**Strategy:** <strategy from fix_summary.remediation_approach>

**Security Pattern Applied:** <security_pattern from fix_summary.remediation_approach>

### Changes Made

#### Primary Changes (Direct Vulnerability Fix)

<For each change in fix_summary.implementation.primary_changes>
**`<file>`** (lines <line_numbers>)
- **Change:** <description>
- **Purpose:** Direct fix for the reported vulnerability
</For each>

<If fix_summary.implementation.supporting_changes exist and are not empty>
#### Supporting Changes (Related Hardening)

<For each change in fix_summary.implementation.supporting_changes>
**`<file>`** (lines <line_numbers>)
- **Change:** <description from the change>
- **Purpose:** <reason from the change>
- **Scope Justification:** <scope_justification from the change>
</For each>
</If>

### Security Improvement

**Before:** <vulnerable state with line number and code evidence>

**After:** <secured state with line number and code evidence>

**Impact:** <explain the mechanism of how the fix eliminates the vulnerability>

### Verification

- Vulnerability eliminated: <vulnerability_eliminated>
- Syntax valid: <syntax_valid>
- Functionality preserved: <functionality_preserved>

**Confidence Level:** <confidence_level from fix_summary.execution_result>

---

*Generated by GitLab Duo Workflow (ID: <workflow_id>)*
</step>

<step number="5" name="SECOND_TOOL_CALL_create_mr">
SECOND TOOL CALL - create_merge_request:

create_merge_request(
    project_id=<project_id>,
    source_branch="<branch_name from step 2>",
    target_branch="{{default_branch}}",
    title="<title from step 4>",
    description="<description from step 4>",
    remove_source_branch=true
)

DO NOT include a "labels" parameter.
</step>
</instructions>

<mr_description_requirements>
Your MR description MUST include:

MANDATORY sections:
- Vulnerability details (ID, type, severity, location)
- Source/sink analysis (where data comes from, how it flows, where it's dangerous)
- Root cause explanation with code-level evidence
- Attack vector explanation
- ALL changes made (primary AND supporting)
- Scope justification for supporting changes
- Before/after security comparison
- Verification status

A reviewer should be able to understand:
1. What was vulnerable and why
2. How it could be exploited
3. What changed and why
4. How the fix eliminates the vulnerability
5. Why supporting changes (if any) are in scope
</mr_description_requirements>

<scope_justification_requirements>
For EVERY supporting change in fix_summary.implementation.supporting_changes:

Include a "Scope Justification" field explaining:
1. How this change relates to the SAME vulnerability type being fixed
2. Why this change is necessary for COMPLETE remediation

**Good**: "This function also processes user input for SQL queries (same weakness type). Hardening it prevents similar vulnerabilities in related code paths."

**Bad**: "Improves security" or "Related to the fix"

If supporting_changes lack scope_justification fields, add a warning:
"Some supporting changes lack explicit scope justification. Human review recommended."
</scope_justification_requirements>

<quantifiable_improvement_requirements>
The "Security Improvement" section MUST show:

1. **Before state**: Vulnerable code with line number and why it's vulnerable
2. **After state**: Secured code with line number and why it's secure
3. **Impact**: The MECHANISM of how the fix eliminates the vulnerability

Do NOT use generic statements like "adds validation which makes the code more secure."
Instead, show specific code changes and explain why the attack vector no longer works.
</quantifiable_improvement_requirements>

<execution_requirements>
1. Make BOTH tool calls in the SAME response
2. First call: run_git_command (push)
3. Second call: create_merge_request
4. Do NOT include "labels" parameter in create_merge_request
5. Parse fix_summary thoroughly to extract ALL analysis details
6. Use markdown formatting for clarity (headers, bold, code blocks, lists)
</execution_requirements>
