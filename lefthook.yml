pre-commit:
  # Parallel script execution is disabled to prevent race conditions
  # when installing dependencies. Multiple scripts trying to modify
  # the same Python packages simultaneously can corrupt the environment.
  # See: https://gitlab.com/gitlab-org/modelops/applied-ml/code-suggestions/ai-assist/-/merge_requests/3160
  parallel: false
  skip:
    - ref: main
  commands:
    lint-python:
      glob: "*.py"
      run: |
        MYPY_SAFE_FILES=$(poetry run python scripts/filter_mypy_excludes.py {staged_files})

        export STAGED_FILES="$(echo '{staged_files}')"

        # Run mypy separately with filtered files
        if [[ -n "$MYPY_SAFE_FILES" ]]; then
          make check-mypy LINT_WORKING_DIR="$MYPY_SAFE_FILES"
        fi

        # Run all other parts of lint-code (everything except check-mypy)
        make flake8 check-black check-isort check-pylint check-codespell check-docformatter check-editorconfig \
        LINT_WORKING_DIR="$STAGED_FILES" \
        CODESPELL_LINT_WORKING_DIR="$STAGED_FILES" \
        EDITORCONFIG_LINT_WORKING_DIR="$STAGED_FILES"
    lint-graphql:
      glob: "*.graphql"
      run: make check-graphql
    lint-other:
      exclude:
        - "*.py"
      run: |
        export STAGED_FILES="$(echo '{staged_files}')"
        make check-codespell CODESPELL_LINT_WORKING_DIR="$STAGED_FILES"
        make check-editorconfig EDITORCONFIG_LINT_WORKING_DIR="$STAGED_FILES"
    lint-doc:
      glob: "*.md"
      run: make lint-doc
pre-push:
  lint-commit:
    run: make lint-commit
